name: Tests Workflow

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: "3.12"

jobs:
  test:
    name: Test package
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 20

      postgres:
        image: postgres:17-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd "pg_isready -U testuser -d testdb"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

      rabbitmq:
        image: rabbitmq:4-management
        ports:
          - 5552:5552
          - 5672:5672
          - 15672:15672
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        volumes:
          - "${{ github.workspace }}/.ci/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro"
          - "${{ github.workspace }}/.ci/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro"
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    steps:
      - name: Checkout (for tests)
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Install test tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade pytest pytest-asyncio

      - name: Install built wheel
        run: |
          python -m pip install dist/*.whl

      - name: Install extra deps
        run: |
          python -m pip install "scitrera-rt-data[all,dev]"

      #      - name: Wait for RabbitMQ Streams port
      #        run: |
      #          for i in {1..30}; do
      #            (echo > /dev/tcp/rabbitmq/5552) >/dev/null 2>&1 && echo "RabbitMQ Streams ready" && exit 0
      #            echo "Waiting for RabbitMQ Streams..."
      #            sleep 2
      #          done
      #          echo "RabbitMQ Streams not ready in time" >&2
      #          exit 1

      - name: Run tests
        env:
          REDIS_HOST: "redis"
          REDIS_PORT: "6379"
          REDIS_DB: "0"
          REDIS_PASSWORD: ""
          PG_DSN: "postgresql://testuser:testpass@postgres:5432/testdb"
          RABBITMQ_DIRECT: true
          RABBITMQ_MTLS: false
          RABBITMQ_HOST: "rabbitmq"
          RABBITMQ_USERNAME: "guest"
          RABBITMQ_PASSWORD: "guest"
          RABBITMQ_PORT: "5552"
          RABBITMQ_VHOST: "/"
        run: |
          pytest -q
